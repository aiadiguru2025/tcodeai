generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, vector]
}

model TransactionCode {
  id                  Int                    @id @default(autoincrement())
  tcode               String                 @unique @db.VarChar(40)
  program             String?                @db.VarChar(100)
  description         String?
  descriptionEnriched String?                @map("description_enriched")
  module              String?                @db.VarChar(20)
  subModule           String?                @map("sub_module") @db.VarChar(40)
  isDeprecated        Boolean                @default(false) @map("is_deprecated")
  s4hanaStatus        String?                @map("s4hana_status") @db.VarChar(20)
  usageCategory       String?                @map("usage_category") @db.VarChar(30)
  embedding           Unsupported("vector")?
  createdAt           DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  feedback            Feedback[]
  searchLogs          SearchLog[]
  sourceRelationships TCodeRelationship[]    @relation("SourceTCode")
  targetRelationships TCodeRelationship[]    @relation("TargetTCode")

  @@index([tcode])
  @@index([module])
  @@index([description])
  @@map("transaction_codes")
}

model TCodeRelationship {
  id               Int             @id @default(autoincrement())
  sourceTcodeId    Int             @map("source_tcode_id")
  targetTcodeId    Int             @map("target_tcode_id")
  relationshipType String          @map("relationship_type") @db.VarChar(30)
  confidence       Float           @default(1.0)
  sourceTcode      TransactionCode @relation("SourceTCode", fields: [sourceTcodeId], references: [id], onDelete: Cascade)
  targetTcode      TransactionCode @relation("TargetTCode", fields: [targetTcodeId], references: [id], onDelete: Cascade)

  @@unique([sourceTcodeId, targetTcodeId, relationshipType])
  @@map("tcode_relationships")
}


model SAPModule {
  code         String   @id @db.VarChar(20)
  name         String   @db.VarChar(100)
  description  String?
  parentModule String?  @map("parent_module") @db.VarChar(20)
  keywords     String[]

  @@map("sap_modules")
}

model SearchLog {
  id              Int              @id @default(autoincrement())
  query           String
  resultsCount    Int?             @map("results_count")
  selectedTcodeId Int?             @map("selected_tcode_id")
  sessionId       String?          @map("session_id") @db.VarChar(100)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  selectedTcode   TransactionCode? @relation(fields: [selectedTcodeId], references: [id])

  @@index([createdAt])
  @@map("search_logs")
}

model Feedback {
  id        Int             @id @default(autoincrement())
  tcodeId   Int             @map("tcode_id")
  sessionId String?         @map("session_id") @db.VarChar(100)
  vote      Int             @db.SmallInt
  comment   String?
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  tcode     TransactionCode @relation(fields: [tcodeId], references: [id], onDelete: Cascade)

  @@index([tcodeId])
  @@map("feedback")
}
